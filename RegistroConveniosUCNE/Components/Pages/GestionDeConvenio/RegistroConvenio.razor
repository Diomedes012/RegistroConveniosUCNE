@page "/crear-convenio"
@inject ConveniosService conveniosService
@inject NavigationManager NavManager
@rendermode InteractiveServer

<div class="page-header">
    <h3>Crear convenio</h3>
</div>

<div class="card shadow-lg">
    <div class="card-header">
        <h5>Registro de Nuevo Convenio</h5>
    </div>

    <EditForm Model="@ConvenioEditar" OnValidSubmit="@GuardarConvenio">
        <DataAnnotationsValidator />
        <div class="card-body">
            <ValidationSummary class="mb-3" />

            <div class="row g-3">

                <div class="col-md-6">
                    <label for="titulo" class="form-label">Título del Convenio:</label>
                    <InputText id="titulo" @bind-Value="ConvenioEditar.Titulo" class="form-control" placeholder="Ej. Acuerdo de cooperación académica" />
                    <ValidationMessage For="@(() => ConvenioEditar.Titulo)" />
                </div>

                <div class="col-md-6">
                    <label for="tipoConvenio" class="form-label">Tipo de Convenio:</label>
                    <InputText id="tipoConvenio" @bind-Value="ConvenioEditar.TipoConvenio" class="form-control" placeholder="Académico, de movilidad, etc." />
                    <ValidationMessage For="@(() => ConvenioEditar.TipoConvenio)" />
                </div>

                <div class="col-md-6">
                    <label for="categoria" class="form-label">Categoría:</label>
                    <InputText id="categoria" @bind-Value="ConvenioEditar.Categoria" class="form-control" placeholder="Convenio, Contrato, MOU..." />
                    <ValidationMessage For="@(() => ConvenioEditar.Categoria)" />
                </div>

                <div class="col-md-6">
                    <label for="fechaFirma" class="form-label">Fecha de Firma:</label>
                    <InputDate id="fechaFirma" @bind-Value="ConvenioEditar.FechaFirma" class="form-control" />
                    <ValidationMessage For="@(() => ConvenioEditar.FechaFirma)" />
                </div>

                <div class="col-md-6">
                    <label for="fechaVencimiento" class="form-label">Fecha de Vencimiento:</label>
                    <InputDate id="fechaVencimiento" @bind-Value="ConvenioEditar.FechaVencimiento" class="form-control" />
                </div>

                <div class="col-md-6">
                    <label for="duracionMeses" class="form-label">Duración (meses):</label>
                    <InputNumber id="duracionMeses" @bind-Value="ConvenioEditar.DuracionMeses" class="form-control" />
                </div>

                <div class="col-md-6">
                    <label for="estado" class="form-label">Estado:</label>
                    <InputSelect id="estado" @bind-Value="ConvenioEditar.Estado" class="form-select">
                        <option value="Activo">Activo</option>
                        <option value="Vencido">Vencido</option>
                        <option value="En Renovación">En Renovación</option>
                    </InputSelect>
                    <ValidationMessage For="@(() => ConvenioEditar.Estado)" />
                </div>

                <div class="col-md-6">
                    <label for="archivo" class="form-label">Archivo del Convenio (PDF, opcional):</label>
                    <InputFile id="archivo" OnChange="OnFileSelected" class="form-control" />
                </div>

                <div class="col-12">
                    <label for="descripcionObjetivos" class="form-label">Descripción y Objetivos:</label>
                    <InputTextArea id="descripcionObjetivos" @bind-Value="ConvenioEditar.DescripcionObjetivos" class="form-control" style="height: 120px;" />
                    <ValidationMessage For="@(() => ConvenioEditar.DescripcionObjetivos)" />
                </div>

            </div>
        </div>

        <div class="card-footer text-end">
            <button type="button" class="btn btn-secondary me-2" @onclick="Volver">Volver</button>
            <button type="submit" class="btn btn-primary">Guardar Convenio</button>
        </div>
    </EditForm>
</div>

@code {
    private IBrowserFile? archivo;
    private Convenio ConvenioEditar = new()
    {
        FechaFirma = DateTime.Now, 
        Estado = "Activo" 
    };

    private async Task GuardarConvenio()
    {
        try
        {
            if (archivo != null)
            {
                var filePath = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", "uploads", archivo.Name);

                var directoryPath = Path.GetDirectoryName(filePath);
                if (directoryPath != null && !Directory.Exists(directoryPath))
                {
                    Directory.CreateDirectory(directoryPath);
                }

                await using var stream = File.Create(filePath);

                await archivo.OpenReadStream(20 * 1024 * 1024).CopyToAsync(stream);

      
                ConvenioEditar.ArchivoPrincipal = $"/uploads/{archivo.Name}";
            }

            ConvenioEditar.UltimaModificacion = DateTime.Now;

            var resultado = await conveniosService.Guardar(ConvenioEditar);

            if (resultado)
            {
                ConvenioEditar = new Convenio() { FechaFirma = DateTime.Now, Estado = "Activo" };
                archivo = null;
                NavManager.NavigateTo("/pantalla-principal");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
    }

    private void OnFileSelected(InputFileChangeEventArgs e)
    {
        archivo = e.File;
    }

    private void Volver()
    {
        NavManager.NavigateTo("/pantalla-principal");
    }
}