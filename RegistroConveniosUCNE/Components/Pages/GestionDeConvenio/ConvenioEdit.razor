@page "/Convenio/Edit/{ConvenioId:int}"
@using GestionConveniosUCNE.Services
@using GestionConveniosUCNE.Models
@inject ConveniosService conveniosService
@inject NavigationManager navigationManager
@rendermode InteractiveServer
@inject IJSRuntime JSRuntime

<div class="pagina-principal">
    <img src="images/image20.png" class="image-5" alt="Fondo" />
    <img src="images/logoUcnePeq.png" class="logo-1" alt="Logo" />

    <div class="main-content-area">

        <div class="pdf-preview-container">
            <h3>Visor del Convenio</h3>

            @if (!string.IsNullOrEmpty(pdfPreviewUrl))
            {
                <object data="@pdfPreviewUrl" type="application/pdf" class="pdf-object">
                    <p>
                        Tu navegador no puede mostrar el PDF.
                        Puedes <a href="@pdfPreviewUrl">descargarlo aquí</a>.
                    </p>
                </object>
            }
            else
            {
                <div class="pdf-placeholder">
                    <p>No hay ningún archivo PDF asociado.</p>
                    <p>(Selecciona un nuevo archivo para previsualizar)</p>
                </div>
            }
        </div>

    <EditForm Model="@ConvenioEditar" OnValidSubmit="@Editar" class="form-container-wrapper">
        <DataAnnotationsValidator />

        <div class="form-container">
            <h3>Editar Convenio</h3>
            <ValidationSummary class="full-width" />

            <div class="form-group">
                <label for="titulo">Título del Convenio:</label>
                <InputText id="titulo" @bind-Value="ConvenioEditar.Titulo" class="form-control" placeholder="Ej. Acuerdo de cooperación académica" readonly="@esEdicion"/>
                <ValidationMessage For="@(() => ConvenioEditar.Titulo)" />
            </div>

            <div class="form-group">
                <label for="tipoConvenio">Tipo de Convenio:</label>
                <InputText id="tipoConvenio" @bind-Value="ConvenioEditar.TipoConvenio" class="form-control" placeholder="Académico, de movilidad, etc." readonly="@esEdicion" />
                <ValidationMessage For="@(() => ConvenioEditar.TipoConvenio)" />
            </div>

            <div class="form-group">
                <label for="categoria">Categoría:</label>
                <InputText id="categoria" @bind-Value="ConvenioEditar.Categoria" class="form-control" placeholder="Convenio, Contrato, MOU..." readonly="@esEdicion" />
                <ValidationMessage For="@(() => ConvenioEditar.Categoria)" />
            </div>

            <div class="form-group">
                <label for="fechaFirma">Fecha de Firma:</label>
                <InputDate id="fechaFirma" @bind-Value="ConvenioEditar.FechaFirma" class="form-control" readonly="@esEdicion" />
                <ValidationMessage For="@(() => ConvenioEditar.FechaFirma)" />
            </div>

            <div class="form-group">
                <label for="fechaVencimiento">Fecha de Vencimiento:</label>
                    <InputDate id="fechaVencimiento" @bind-Value="ConvenioEditar.FechaVencimiento" class="form-control" readonly="@esEdicion" />
            </div>

            <div class="form-group">
                <label for="duracionMeses">Duración (meses):</label>
                <InputNumber id="duracionMeses" @bind-Value="ConvenioEditar.DuracionMeses" class="form-control" readonly="@esEdicion" />
            </div>

            <div class="form-group">
                <label for="estado">Estado:</label>
                <InputSelect id="estado" @bind-Value="ConvenioEditar.Estado" class="form-control" disabled="@esEdicion">
                    <option value="Activo">Activo</option>
                    <option value="Vencido">Vencido</option>
                    <option value="En Renovación">En Renovación</option>
                </InputSelect>
                <ValidationMessage For="@(() => ConvenioEditar.Estado)" />
            </div>

            <div class="form-group">
                <label for="archivo">Archivo del Convenio (PDF):</label>
                <InputFile id="archivo" OnChange="OnFileSelected" class="form-control" disabled="@esEdicion" />
            </div>

            <div class="form-group full-width">
                <label for="descripcionObjetivos">Descripción y Objetivos:</label>
                <InputTextArea id="descripcionObjetivos" @bind-Value="ConvenioEditar.DescripcionObjetivos" class="form-control textarea-large" readonly="@esEdicion" />
                <ValidationMessage For="@(() => ConvenioEditar.DescripcionObjetivos)" />
            </div>

            <div class="form-actions full-width">
                @if(esEdicion)
                {
                        <button type="button" class="btn btn-secondary" @onclick="HabilitarEdicion">Editar</button>
                }
                else
                {
                    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                    <button type="button" class="btn btn-danger" @onclick="Eliminar">Eliminar</button>
                }
                
            </div>

        </div>
    </EditForm>
</div></div>

@code {
    [Parameter]
    public int ConvenioId { get; set; }

    public Convenio ConvenioEditar { get; set; } = new Convenio();
    //variables del lector pdf
    private string? pdfPreviewUrl;
    private IBrowserFile? selectedFile;
    private bool _showPdfViewer = false; // Controla si el visor está visible
    private const long maxFileSize = 50 * 1024 * 1024; // 50 MB

    //Variable para habilitar edicion
    private bool esEdicion = true;


    protected override async Task OnInitializedAsync()
    {
        var convenio = await conveniosService.Buscar(ConvenioId);

        if(convenio != null)
        {
            ConvenioEditar = convenio;
            pdfPreviewUrl = ConvenioEditar.ArchivoPrincipal;
        }

    }


    public async Task Editar()
    {
        var guardado = await conveniosService.Guardar(ConvenioEditar);

        if (guardado)
        {
            //Mostrar mensaje de Exito (Tal vez Toast)
            navigationManager.NavigateTo("/listar-convenio");
        }
        else
        {
            //Mostar mensaaje de Fracaso
        }
    }

    // Método para alternar la visibilidad del visor
    private void TogglePdfViewer()
    {
        _showPdfViewer = !_showPdfViewer;
    }

    public async Task OnFileSelected(InputFileChangeEventArgs e)
    {
        if (pdfPreviewUrl != null && pdfPreviewUrl.StartsWith("Blob:"))
            await JSRuntime.InvokeVoidAsync("revokeBlobUrl", pdfPreviewUrl);

        selectedFile = e.File;
        if (selectedFile == null || selectedFile.ContentType != "application/pdf")
        {
            pdfPreviewUrl = ConvenioEditar.ArchivoPrincipal;
            selectedFile = null;
            return;
        }

        try
        {
            using var streamRef = new DotNetStreamReference(selectedFile.OpenReadStream(maxFileSize));
            pdfPreviewUrl = await JSRuntime.InvokeAsync<string>("createBlobUrlFromStream", streamRef);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al previsualizar el archivo: {ex.Message}");
            pdfPreviewUrl = ConvenioEditar.ArchivoPrincipal;
        }
    }

    public async Task Eliminar()
    {
        var ocultado = await conveniosService.Buscar(ConvenioId);

        if (ocultado != null)
        {
            ocultado.EsVisible = false;

            ConvenioEditar = ocultado;

            var guardado = await conveniosService.Guardar(ConvenioEditar);

            if (guardado)
            {
                navigationManager.NavigateTo("/listar-convenio");
            }
            else
            {
                //Notificacion de error
            }
        }

    }

    //Interruptor para habilitar edicion
    private void HabilitarEdicion()
    {
        if(!esEdicion)
        {
            esEdicion = true;
        }
        else
        {
            esEdicion = false;
        }
    }
}
