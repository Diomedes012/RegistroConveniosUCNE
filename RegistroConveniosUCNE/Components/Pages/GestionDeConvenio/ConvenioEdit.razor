@page "/Convenio/Edit/{ConvenioId:int}"
@using GestionConveniosUCNE.Services
@using GestionConveniosUCNE.Models
@inject ConveniosService conveniosService
@inject NavigationManager navigationManager
@rendermode InteractiveServer
@inject IJSRuntime JSRuntime

<div class="page-header">
    <h3>Editar Convenio (ID: @ConvenioId)</h3>
</div>

<div class="card shadow-lg mb-4">
    <div class="card-header">
        <h5>Datos del Convenio</h5>
    </div>

    <EditForm Model="@ConvenioEditar" OnValidSubmit="@GuardarCambios">
        <DataAnnotationsValidator />
        <div class="card-body">
            <ValidationSummary class="mb-3" />
            <div class="row g-3">

                <div class="col-md-6">
                    <label for="titulo" class="form-label">Título del Convenio:</label>
                    <InputText id="titulo" @bind-Value="ConvenioEditar.Titulo" class="form-control" placeholder="Ej. Acuerdo de cooperación académica" />
                    <ValidationMessage For="@(() => ConvenioEditar.Titulo)" />
                </div>

                <div class="col-md-6">
                    <label for="tipoConvenio" class="form-label">Tipo de Convenio:</label>
                    <InputText id="tipoConvenio" @bind-Value="ConvenioEditar.TipoConvenio" class="form-control" placeholder="Académico, de movilidad, etc." />
                    <ValidationMessage For="@(() => ConvenioEditar.TipoConvenio)" />
                </div>

                <div class="col-md-6">
                    <label for="categoria" class="form-label">Categoría:</label>
                    <InputText id="categoria" @bind-Value="ConvenioEditar.Categoria" class="form-control" placeholder="Convenio, Contrato, MOU..." />
                    <ValidationMessage For="@(() => ConvenioEditar.Categoria)" />
                </div>

                <div class="col-md-6">
                    <label for="fechaFirma" class="form-label">Fecha de Firma:</label>
                    <InputDate id="fechaFirma" @bind-Value="ConvenioEditar.FechaFirma" class="form-control" />
                    <ValidationMessage For="@(() => ConvenioEditar.FechaFirma)" />
                </div>

                <div class="col-md-6">
                    <label for="fechaVencimiento" class="form-label">Fecha de Vencimiento:</label>
                    <InputDate id="fechaVencimiento" @bind-Value="ConvenioEditar.FechaVencimiento" class="form-control" />
                </div>

                <div class="col-md-6">
                    <label for="duracionMeses" class="form-label">Duración (meses):</label>
                    <InputNumber id="duracionMeses" @bind-Value="ConvenioEditar.DuracionMeses" class="form-control" />
                </div>

                <div class="col-md-6">
                    <label for="estado" class="form-label">Estado:</label>
                    <InputSelect id="estado" @bind-Value="ConvenioEditar.Estado" class="form-select">
                        <option value="Activo">Activo</option>
                        <option value="Vencido">Vencido</option>
                        <option value="En Renovación">En Renovación</option>
                    </InputSelect>
                    <ValidationMessage For="@(() => ConvenioEditar.Estado)" />
                </div>

                <div class="col-md-6">
                    <label for="archivo" class="form-label">Actualizar Archivo (PDF):</label>
                    <InputFile id="archivo" OnChange="OnFileSelected" class="form-control" />
                </div>

                <div class="col-12">
                    <label for="descripcionObjetivos" class="form-label">Descripción y Objetivos:</label>
                    <InputTextArea id="descripcionObjetivos" @bind-Value="ConvenioEditar.DescripcionObjetivos" class="form-control" style="height: 120px;" />
                    <ValidationMessage For="@(() => ConvenioEditar.DescripcionObjetivos)" />
                </div>
            </div>
        </div>

        <div class="card-footer text-end">
            <button type="button" class="btn btn-secondary me-auto" @onclick="Volver">Volver a la Lista</button>
            <button type="button" class="btn btn-danger me-2" @onclick="Eliminar">Eliminar</button>
            <button type="submit" class="btn btn-primary">Guardar Cambios</button>
        </div>
    </EditForm>
</div>

<div class="card shadow-lg">
    <div class="card-header">
        <h5>Visor del Convenio</h5>
    </div>
    <div class="card-body pdf-preview-container">
        @if (!string.IsNullOrEmpty(pdfPreviewUrl))
        {
            <object data="@pdfPreviewUrl" type="application/pdf" class="pdf-object">
                <p>
                    Tu navegador no puede mostrar el PDF.
                    Puedes <a href="@pdfPreviewUrl" target="_blank">descargarlo aquí</a>.
                </p>
            </object>
        }
        else
        {
            <div class="pdf-placeholder">
                <p>No hay ningún archivo PDF asociado a este convenio.</p>
                <p>(Si subes uno nuevo, aparecerá aquí)</p>
            </div>
        }
    </div>
</div>


@code {
    [Parameter]
    public int ConvenioId { get; set; }

    public Convenio ConvenioEditar { get; set; } = new Convenio();

    // Variables del lector PDF
    private string? pdfPreviewUrl;
    private IBrowserFile? selectedFile;
    private const long maxFileSize = 50 * 1024 * 1024; // 50 MB

    protected override async Task OnInitializedAsync()
    {
        var convenio = await conveniosService.Buscar(ConvenioId);
        if (convenio != null)
        {
            ConvenioEditar = convenio;
            // Carga el PDF existente al iniciar
            pdfPreviewUrl = ConvenioEditar.ArchivoPrincipal;
        }
    }

    public async Task GuardarCambios()
    {
        // Lógica para guardar el archivo si se seleccionó uno nuevo
        if (selectedFile != null)
        {
            try
            {
                var filePath = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", "uploads", selectedFile.Name);
                var directoryPath = Path.GetDirectoryName(filePath);
                if (directoryPath != null && !Directory.Exists(directoryPath))
                {
                    Directory.CreateDirectory(directoryPath);
                }

                await using var stream = File.Create(filePath);
                await selectedFile.OpenReadStream(maxFileSize).CopyToAsync(stream);

                // Actualiza la ruta del archivo en el modelo
                ConvenioEditar.ArchivoPrincipal = $"/uploads/{selectedFile.Name}";
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error al guardar el nuevo archivo: {ex.Message}");
                // Mostrar error al usuario
                return;
            }
        }

        // Lógica para guardar el convenio (tomada de tu código)
        var guardado = await conveniosService.Guardar(ConvenioEditar);
        if (guardado)
        {
            navigationManager.NavigateTo("/listar-convenio");
        }
    }

    public async Task OnFileSelected(InputFileChangeEventArgs e)
    {
        // Limpia el visor anterior si era un Blob temporal
        if (pdfPreviewUrl != null && pdfPreviewUrl.StartsWith("blob:"))
            await JSRuntime.InvokeVoidAsync("revokeBlobUrl", pdfPreviewUrl);

        selectedFile = e.File;
        if (selectedFile == null || selectedFile.ContentType != "application/pdf")
        {
            // Si el archivo no es PDF, vuelve a mostrar el original
            pdfPreviewUrl = ConvenioEditar.ArchivoPrincipal;
            selectedFile = null;
            return;
        }

        // Genera una URL temporal (Blob) para la previsualización
        try
        {
            using var streamRef = new DotNetStreamReference(selectedFile.OpenReadStream(maxFileSize));
            pdfPreviewUrl = await JSRuntime.InvokeAsync<string>("createBlobUrlFromStream", streamRef);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al previsualizar el archivo: {ex.Message}");
            pdfPreviewUrl = ConvenioEditar.ArchivoPrincipal;
        }
    }

    public async Task Eliminar()
    {
        // Pedir confirmación
        var confirmado = await JSRuntime.InvokeAsync<bool>("confirm", $"¿Estás seguro de que quieres eliminar el convenio '{ConvenioEditar.Titulo}'?");

        if (!confirmado)
            return;

        // Lógica de borrado suave (tomada de tu código)
        var ocultado = await conveniosService.Buscar(ConvenioId);
        if (ocultado != null)
        {
            ocultado.EsVisible = false;
            var guardado = await conveniosService.Guardar(ocultado);
            if (guardado)
            {
                navigationManager.NavigateTo("/listar-convenio");
            }
        }
    }

    private void Volver()
    {
        navigationManager.NavigateTo("/listar-convenio");
    }
}